<div class="game-container">
  @if (showGameBoard()) {
    <!-- Milestone 4 Game Board UI with Real Gameplay -->
    <app-game-board
      [playerCardCount]="playerCardCount()"
      [opponentCardCount]="opponentCardCount()"
      [playerActiveCard]="playerActiveCard()"
      [opponentActiveCard]="opponentActiveCard()"
      [playerCardGlow]="playerCardGlow()"
      [opponentCardGlow]="opponentCardGlow()"
      [playerCardAnimation]="playerCardAnimation()"
      [opponentCardAnimation]="opponentCardAnimation()"
      [playerHealthDamageAnimation]="playerHealthDamageAnimation()"
      [opponentHealthDamageAnimation]="opponentHealthDamageAnimation()"
      [gameMessage]="gameMessage()"
      [challengeAvailable]="challengeAvailable()"
      [canPlayerAct]="effectiveCanPlayerAct()"
      [turnNumber]="gameStateService.gameStats().turnNumber"
      (playerDeckClicked)="onPlayerDeckClick()">
    </app-game-board>

    <!-- Challenge Prompt Modal -->
    @if (showChallengePrompt()) {
      <div class="challenge-overlay">
        <mat-card class="challenge-card">
          <mat-card-header>
            <mat-card-title>Challenge Available!</mat-card-title>
            <mat-card-subtitle>Do you want to challenge the result?</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <!-- Show the current turn cards for context -->
            <div class="turn-context">
              <h4>This Turn's Cards:</h4>
              <div class="cards-display">
                <div class="player-card-info">
                  <span>Your Card (Lost):</span>
                  @if (playerActiveCard()) {
                    <app-card [card]="playerActiveCard()" [glow]="'red'" [faceDown]="false"></app-card>
                  }
                </div>
                <div class="opponent-card-info">
                  <span>Opponent's Card (Won):</span>
                  @if (opponentActiveCard()) {
                    <app-card [card]="opponentActiveCard()" [glow]="'green'" [faceDown]="false"></app-card>
                  }
                </div>
              </div>
            </div>
            
            <p>You lost this round, but you can draw an additional card to challenge the result.</p>
            <p><strong>Risk:</strong> If you lose the challenge, you lose both cards!</p>
            <p><strong>Challenge Rule:</strong> Your new card will be compared against the opponent's winning card above.</p>
          </mat-card-content>
          <mat-card-actions>
            <button mat-raised-button color="primary" (click)="acceptChallenge()">
              Accept Challenge
            </button>
            <button mat-button (click)="declineChallenge()">
              Decline
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    }

    <!-- Challenge Card Display Modal -->
    @if (showChallengeCardDisplay()) {
      <div class="challenge-overlay">
        <mat-card class="challenge-card">
          <mat-card-header>
            <mat-card-title>Your Challenge Card</mat-card-title>
            <mat-card-subtitle>This is the card you drew for your challenge</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <!-- Show the original turn context -->
            <div class="turn-context">
              <h4>Original Turn:</h4>
              <div class="cards-display">
                <div class="player-card-info">
                  <span>Your Original Card:</span>
                  @if (playerActiveCard()) {
                    <app-card [card]="playerActiveCard()" [glow]="'red'" [faceDown]="false"></app-card>
                  }
                </div>
                <div class="opponent-card-info">
                  <span>Opponent's Card:</span>
                  @if (opponentActiveCard()) {
                    <app-card [card]="opponentActiveCard()" [glow]="'green'" [faceDown]="false"></app-card>
                  }
                </div>
              </div>
            </div>

            <!-- Show the challenge card -->
            <div class="challenge-card-display">
              <h4>Your Challenge Card:</h4>
              @if (challengeCard()) {
                <app-card 
                  [card]="challengeCard()" 
                  [glow]="'blue'"
                  [animationState]="'flip'">
                </app-card>
              }
            </div>
            
            <p><strong>Challenge Comparison:</strong> Your challenge card vs. opponent's winning card</p>
            <p>If your challenge card wins, you keep both of your cards and the opponent's card is discarded.</p>
            <p>If your challenge card loses or ties, you lose both cards and the opponent keeps their card.</p>
          </mat-card-content>
          <mat-card-actions>
            <button mat-raised-button color="primary" (click)="confirmChallenge()">
              Continue with Challenge
            </button>
          </mat-card-actions>
        </mat-card>
      </div>
    }

    <!-- Battle Selection Modal -->
    @if (showBattleUI()) {
      <div class="battle-overlay">
        <mat-card class="battle-card">
          <mat-card-header>
            <mat-card-title>Battle Time!</mat-card-title>
            <mat-card-subtitle>Select one of the opponent's face-down cards</mat-card-subtitle>
          </mat-card-header>
          <mat-card-content>
            <p>Cards are tied! Both players have placed 3 cards face-down for battle.</p>
            <div class="battle-cards">
              <h4>Opponent's Cards (Select One):</h4>
              <div class="opponent-battle-cards">
                @for (card of opponentBattleCards(); track $index) {
                  <app-card
                    [card]="null"
                    [faceDown]="true"
                    [glow]="'blue'"
                    [clickable]="true"
                    (cardClicked)="onBattleCardSelect(card)">
                  </app-card>
                }
              </div>
              
              <h4>Your Cards in Battle:</h4>
              <div class="player-battle-cards">
                @for (card of battleCards(); track $index) {
                  <app-card
                    [card]="null"
                    [faceDown]="true">
                  </app-card>
                }
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    }

    <!-- Game Controls -->
    <div class="game-controls">
      <button mat-raised-button color="primary" (click)="startNewGame()">
        New Game
      </button>
      <button mat-raised-button (click)="openDiscardPileViewer()">
        Discard Pile
        @if (gameStateService.discardedCardCount() > 0) {
          <span class="discard-count">({{ gameStateService.discardedCardCount() }})</span>
        }
      </button>
      <button mat-button (click)="toggleDemo()">
        Show Old Demo
      </button>
    </div>
  } @else {
    <!-- Original Milestone 2 Demo -->
    <mat-card class="welcome-card">
      <mat-card-header>
        <mat-card-title>War of Attrition - Milestone 3 Complete! ðŸŽ‰</mat-card-title>
        <mat-card-subtitle>Basic UI Components Implementation</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        <p><strong>Milestone 3 has been successfully completed!</strong> Core UI components are implemented and functional.</p>
        
        <h3>New UI Components:</h3>
        <ul>
          <li><strong>Game Board Layout:</strong> Head-to-head player layout with solitaire green background</li>
          <li><strong>Card Component:</strong> Visual card representation with red/black suits and glow effects</li>
          <li><strong>Health Bar Component:</strong> Color-coded health bars (Greenâ†’Yellowâ†’Orangeâ†’Red)</li>
          <li><strong>Action Indicators:</strong> Blue glow effects for player actions</li>
        </ul>

        <h3>Previous - Game Engine Demo:</h3>
        <div class="demo-output">
          @for (line of demoLog(); track $index) {
            <div class="demo-line">{{ line }}</div>
          }
        </div>
      </mat-card-content>
      <mat-card-actions>
        <button mat-raised-button color="primary" (click)="toggleDemo()">
          Show New Game Board
        </button>
        <button mat-raised-button color="primary" (click)="runDemo()">Run Demo Again</button>
        <button mat-button routerLink="/settings">Settings</button>
      </mat-card-actions>
    </mat-card>
  }
</div>
